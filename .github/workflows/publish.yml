name: Publish

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Package version (example: 0.1.0-beta.1)"
        required: false
        default: "0.1.0-beta.1"

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve package version
        id: meta
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="${{ inputs.version }}"
          fi

          if [[ -z "${version}" ]]; then
            echo "Version input is required." >&2
            exit 1
          fi

          echo "package_version=${version}" >> "${GITHUB_OUTPUT}"
          echo "tag_name=v${version}" >> "${GITHUB_OUTPUT}"
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
      - run: npm install
      - name: Build npm package
        shell: bash
        run: |
          npm pkg set version="${{ steps.meta.outputs.package_version }}"
          npm run build
          rm -rf dist-release
          mkdir -p dist-release
          npm pack
          mv ./*.tgz dist-release/
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-ts-${{ steps.meta.outputs.package_version }}
          path: dist-release/*
      - name: Publish package to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          prerelease: ${{ contains(steps.meta.outputs.package_version, '-') }}
          generate_release_notes: true
          files: dist-release/*
      - name: Publish to npm
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && env.NPM_TOKEN != ''
        shell: bash
        run: |
          if [[ "${{ steps.meta.outputs.package_version }}" == *-* ]]; then
            npm publish --access public --provenance --tag beta
          else
            npm publish --access public --provenance
          fi
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
